name: N8N Bidirectional Workflow Sync

on:
  workflow_dispatch:
    inputs:
      sync_direction:
        description: 'Sync direction'
        required: true
        type: choice
        options:
          - push
          - pull
        default: 'push'
      workflow_name:
        description: 'Workflow name (optional - leave empty for all workflows)'
        required: false
        type: string
        default: ''

jobs:
  push-to-n8n:
    name: Push Workflows to N8N
    runs-on: ubuntu-latest
    if: github.event.inputs.sync_direction == 'push'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm install axios
      
      - name: Verify workflows directory
        run: |
          echo "Checking for workflows directory..."
          if [ -d "workflows" ]; then
            echo "âœ… Workflows directory exists"
            echo "Contents:"
            ls -la workflows/
          else
            echo "âŒ Workflows directory not found!"
            exit 1
          fi
      
      - name: Push workflows to N8N
        env:
          N8N_API_KEY: ${{ secrets.N8NAPIKEY }}
          N8N_BASE_URL: ${{ secrets.N8N_BASE_URL }}
          WORKFLOW_NAME: ${{ github.event.inputs.workflow_name }}
        run: |
          cat > push_workflows.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const axios = require('axios');

          const N8N_API_KEY = process.env.N8N_API_KEY;
          const N8N_BASE_URL = process.env.N8N_BASE_URL || 'http://localhost:5678';
          const WORKFLOW_NAME = process.env.WORKFLOW_NAME;

          if (!N8N_API_KEY) {
            console.error('âŒ N8N_API_KEY is not set');
            process.exit(1);
          }

          const axiosConfig = {
            headers: {
              'X-N8N-API-KEY': N8N_API_KEY,
              'Content-Type': 'application/json'
            }
          };

          console.log('ğŸš€ Pushing workflows to N8N...');
          console.log(`ğŸ“ N8N URL: ${N8N_BASE_URL}`);

          async function pushWorkflow(filePath) {
            try {
              const workflowData = JSON.parse(fs.readFileSync(filePath, 'utf8'));
              const workflowName = path.basename(filePath, '.json');
              
              console.log(`\nğŸ“¦ Processing: ${workflowName}`);
              
              // First, try to find existing workflow by name
              const response = await axios.get(
                `${N8N_BASE_URL}/api/v1/workflows`,
                axiosConfig
              );
              
              const existingWorkflow = response.data.data.find(w => w.name === workflowData.name);
              
              if (existingWorkflow) {
                console.log(`   â†ªï¸  Updating existing workflow (ID: ${existingWorkflow.id})`);
                await axios.patch(
                  `${N8N_BASE_URL}/api/v1/workflows/${existingWorkflow.id}`,
                  workflowData,
                  axiosConfig
                );
                console.log(`   âœ… Successfully updated`);
              } else {
                console.log(`   â†ªï¸  Creating new workflow`);
                await axios.post(
                  `${N8N_BASE_URL}/api/v1/workflows`,
                  workflowData,
                  axiosConfig
                );
                console.log(`   âœ… Successfully created`);
              }
              
              return { success: true, name: workflowName };
            } catch (error) {
              console.error(`   âŒ Error: ${error.message}`);
              if (error.response) {
                console.error(`   Response: ${JSON.stringify(error.response.data)}`);
              }
              return { success: false, name: path.basename(filePath, '.json'), error: error.message };
            }
          }

          async function main() {
            const workflowsDir = 'workflows';
            let results = [];
            
            if (WORKFLOW_NAME) {
              const filePath = path.join(workflowsDir, `${WORKFLOW_NAME}.json`);
              if (fs.existsSync(filePath)) {
                results.push(await pushWorkflow(filePath));
              } else {
                console.error(`âŒ Workflow file not found: ${filePath}`);
                process.exit(1);
              }
            } else {
              const files = fs.readdirSync(workflowsDir).filter(f => f.endsWith('.json'));
              console.log(`Found ${files.length} workflow file(s)`);
              
              for (const file of files) {
                const filePath = path.join(workflowsDir, file);
                results.push(await pushWorkflow(filePath));
              }
            }
            
            // Summary
            const successful = results.filter(r => r.success).length;
            const failed = results.filter(r => !r.success).length;
            
            console.log('\n' + 'â•'.repeat(60));
            console.log(`ğŸ“Š Summary: ${successful} successful, ${failed} failed`);
            console.log('â•'.repeat(60));
            
            if (failed > 0) {
              process.exit(1);
            }
          }

          main();
          EOF
          
          node push_workflows.js
      
      - name: ğŸ“Š Push Summary
        if: always()
        env:
          WORKFLOW_NAME: ${{ github.event.inputs.workflow_name }}
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ N8N WORKFLOW PUSH SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "â° Timestamp: $timestamp"
          echo ""
          
          if [ -n "$WORKFLOW_NAME" ]; then
            echo "âœ… Pushed updates to workflow: ã€ $WORKFLOW_NAME ã€‘"
            echo ""
            echo "ğŸ“¦ Workflow Details:"
            echo "   â€¢ Name: $WORKFLOW_NAME"
            echo "   â€¢ File: workflows/${WORKFLOW_NAME}.json"
            echo "   â€¢ Status: Successfully pushed to N8N"
          else
            echo "âœ… Pushed updates to ALL workflows"
            echo ""
            echo "ğŸ“¦ Processed Workflows:"
            for workflow_file in workflows/*.json; do
              if [ -f "$workflow_file" ]; then
                workflow_name=$(basename "$workflow_file" .json)
                echo "   â€¢ ã€ $workflow_name ã€‘ â†’ Successfully pushed"
              fi
            done
          fi
          
          echo ""
          echo "ğŸ”„ Sync Direction: Repository â†’ N8N"
          echo "âœ¨ Status: COMPLETED"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

  pull-from-n8n:
    name: Pull Workflows from N8N
    runs-on: ubuntu-latest
    if: github.event.inputs.sync_direction == 'pull'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm install axios
      
      - name: Create workflows directory
        run: |
          echo "ğŸ“ Ensuring workflows directory exists..."
          mkdir -p workflows
          echo "âœ… Directory ready: $(pwd)/workflows"
      
      - name: Debug - Show current state
        run: |
          echo "ğŸ” Current repository state:"
          echo "Working directory: $(pwd)"
          echo ""
          echo "Directory structure:"
          ls -la
          echo ""
          if [ -d "workflows" ]; then
            echo "Existing workflows directory contents:"
            ls -la workflows/ || echo "Directory is empty"
            echo ""
            echo "Current workflow files:"
            find workflows -name "*.json" -type f || echo "No JSON files found"
          fi
      
      - name: Pull workflows from N8N
        env:
          N8N_API_KEY: ${{ secrets.N8NAPIKEY }}
          N8N_BASE_URL: ${{ secrets.N8N_BASE_URL }}
          WORKFLOW_NAME: ${{ github.event.inputs.workflow_name }}
        run: |
          cat > pull_workflows.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const axios = require('axios');

          const N8N_API_KEY = process.env.N8N_API_KEY;
          const N8N_BASE_URL = process.env.N8N_BASE_URL || 'http://localhost:5678';
          const WORKFLOW_NAME = process.env.WORKFLOW_NAME;

          if (!N8N_API_KEY) {
            console.error('âŒ N8N_API_KEY is not set');
            process.exit(1);
          }

          const axiosConfig = {
            headers: {
              'X-N8N-API-KEY': N8N_API_KEY,
              'Content-Type': 'application/json'
            }
          };

          console.log('â¬‡ï¸  Pulling workflows from N8N...');
          console.log(`ğŸ“ N8N URL: ${N8N_BASE_URL}`);
          console.log(`ğŸ”‘ API Key configured: ${N8N_API_KEY.substring(0, 8)}...`);

          async function pullWorkflows() {
            try {
              console.log('\nğŸ“¡ Fetching workflows from N8N API...');
              
              const response = await axios.get(
                `${N8N_BASE_URL}/api/v1/workflows`,
                axiosConfig
              );
              
              const workflows = response.data.data;
              console.log(`âœ… Retrieved ${workflows.length} workflow(s) from N8N`);
              
              if (workflows.length === 0) {
                console.log('âš ï¸  No workflows found in N8N instance');
                return [];
              }
              
              const workflowsDir = 'workflows';
              if (!fs.existsSync(workflowsDir)) {
                fs.mkdirSync(workflowsDir, { recursive: true });
              }
              
              let savedWorkflows = [];
              
              for (const workflow of workflows) {
                // If specific workflow requested, filter by name
                if (WORKFLOW_NAME && workflow.name !== WORKFLOW_NAME) {
                  continue;
                }
                
                console.log(`\nğŸ“¦ Processing: ${workflow.name} (ID: ${workflow.id})`);
                
                // Fetch full workflow details
                const detailResponse = await axios.get(
                  `${N8N_BASE_URL}/api/v1/workflows/${workflow.id}`,
                  axiosConfig
                );
                
                const workflowData = detailResponse.data.data;
                
                // Clean filename
                const fileName = workflow.name.replace(/[^a-z0-9_-]/gi, '_').toLowerCase();
                const filePath = path.join(workflowsDir, `${fileName}.json`);
                
                // Read existing file if it exists
                let hasChanges = true;
                if (fs.existsSync(filePath)) {
                  const existingContent = fs.readFileSync(filePath, 'utf8');
                  const newContent = JSON.stringify(workflowData, null, 2);
                  
                  hasChanges = existingContent !== newContent;
                  
                  if (hasChanges) {
                    console.log(`   â†ªï¸  Changes detected - updating file`);
                  } else {
                    console.log(`   â†ªï¸  No changes - file is up to date`);
                  }
                } else {
                  console.log(`   â†ªï¸  New workflow - creating file`);
                }
                
                // Write workflow to file
                fs.writeFileSync(filePath, JSON.stringify(workflowData, null, 2) + '\n');
                console.log(`   âœ… Saved to: ${filePath}`);
                
                savedWorkflows.push({
                  name: workflow.name,
                  file: filePath,
                  hasChanges: hasChanges,
                  isNew: !fs.existsSync(filePath)
                });
              }
              
              return savedWorkflows;
              
            } catch (error) {
              console.error(`âŒ Error fetching workflows: ${error.message}`);
              if (error.response) {
                console.error(`   Status: ${error.response.status}`);
                console.error(`   Response: ${JSON.stringify(error.response.data)}`);
              }
              if (error.code === 'ECONNREFUSED') {
                console.error('   âš ï¸  Cannot connect to N8N. Check N8N_BASE_URL.');
              }
              throw error;
            }
          }

          async function main() {
            try {
              const results = await pullWorkflows();
              
              console.log('\n' + 'â•'.repeat(60));
              console.log(`ğŸ“Š Successfully pulled ${results.length} workflow(s)`);
              
              if (results.length > 0) {
                console.log('\nğŸ“„ Workflow Details:');
                results.forEach(r => {
                  const status = r.isNew ? 'ğŸ†• NEW' : (r.hasChanges ? 'ğŸ“ UPDATED' : 'âœ“ UNCHANGED');
                  console.log(`   ${status} - ${r.name}`);
                  console.log(`      â””â”€ ${r.file}`);
                });
              }
              
              console.log('â•'.repeat(60));
              
            } catch (error) {
              console.error('\nâŒ Failed to pull workflows');
              process.exit(1);
            }
          }

          main();
          EOF
          
          node pull_workflows.js
      
      - name: Show changes
        run: |
          echo "ğŸ” Checking for changes in workflows directory..."
          echo ""
          echo "Git status:"
          git status workflows/
          echo ""
          
          if [ -d "workflows" ] && [ "$(ls -A workflows/*.json 2>/dev/null)" ]; then
            echo "ğŸ“Š Workflow files:"
            for file in workflows/*.json; do
              if [ -f "$file" ]; then
                echo "  â€¢ $(basename "$file")"
                echo "    Size: $(wc -c < "$file") bytes"
                echo "    Modified: $(stat -c %y "$file" 2>/dev/null || stat -f %Sm "$file")"
              fi
            done
            echo ""
          fi
          
          if git diff --quiet workflows/; then
            echo "âœ… No changes detected - all workflows are up to date"
          else
            echo "ğŸ“ Changes detected:"
            git diff --stat workflows/
            echo ""
            echo "Detailed changes:"
            git diff workflows/
          fi
      
      - name: Check for changes
        id: check_changes
        run: |
          # Check if there are any changes
          if git diff --quiet workflows/ && git diff --cached --quiet workflows/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "CHANGES_DETECTED=false" >> $GITHUB_ENV
            echo "âš ï¸  No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "CHANGES_DETECTED=true" >> $GITHUB_ENV
            echo "âœ… Changes detected and ready to commit"
            
            # Get list of changed files
            changed_files=$(git diff --name-only workflows/ && git diff --cached --name-only workflows/ | sort -u | sed 's/^/   â€¢ /')
            echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
            echo "$changed_files" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # Get diff stats
            added=$(git diff --numstat workflows/ | awk '{sum+=$1} END {print sum+0}')
            deleted=$(git diff --numstat workflows/ | awk '{sum+=$2} END {print sum+0}')
            echo "LINES_ADDED=$added" >> $GITHUB_ENV
            echo "LINES_DELETED=$deleted" >> $GITHUB_ENV
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ’¾ Committing changes..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add workflows/
          
          # Double check there are staged changes
          if git diff --staged --quiet; then
            echo "âš ï¸  No staged changes to commit"
          else
            git commit -m "ğŸ”„ Update workflows from N8N

Automatically synced workflows from N8N instance.

$(git diff --staged --stat workflows/)
"
            git push
            echo "âœ… Changes committed and pushed successfully"
          fi
      
      - name: ğŸ“Š Pull Summary
        if: always()
        env:
          WORKFLOW_NAME: ${{ github.event.inputs.workflow_name }}
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â¬‡ï¸  N8N WORKFLOW PULL SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "â° Timestamp: $timestamp"
          echo ""
          
          if [ -n "$WORKFLOW_NAME" ]; then
            echo "ğŸ¯ Target: Specific workflow - ã€ $WORKFLOW_NAME ã€‘"
            echo ""
            echo "ğŸ“¦ Workflow Details:"
            echo "   â€¢ Name: $WORKFLOW_NAME"
            echo "   â€¢ Target: workflows/\${WORKFLOW_NAME}.json"
          else
            echo "ğŸ¯ Target: ALL workflows from N8N"
            echo ""
            echo "ğŸ“¦ Target Directory: workflows/"
          fi
          
          echo ""
          echo "ğŸ“ Changes Summary:"
          
          if [ "${CHANGES_DETECTED:-false}" = "true" ]; then
            echo "   â€¢ Status: âœ… Changes detected and committed"
            echo "   â€¢ Lines added: ${LINES_ADDED:-0}"
            echo "   â€¢ Lines deleted: ${LINES_DELETED:-0}"
            echo ""
            echo "ğŸ“„ Modified Files:"
            echo "${CHANGED_FILES}"
            echo ""
            echo "ğŸ’¾ Changes have been committed and pushed to repository"
          else
            echo "   â€¢ Status: âœ… No changes detected"
            echo "   â€¢ All workflows are up to date"
            echo ""
            if [ -d "workflows" ]; then
              echo "ğŸ“‚ Current workflows in repository:"
              for file in workflows/*.json; do
                if [ -f "$file" ]; then
                  echo "   â€¢ $(basename "$file")"
                fi
              done
            fi
          fi
          
          echo ""
          echo "ğŸ”„ Sync Direction: N8N â†’ Repository"
          echo "âœ¨ Status: COMPLETED"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
