name: Deploy Owntracks n8n Workflow

# This workflow creates and deploys an n8n workflow that:
# 1. Receives Owntracks location updates via webhook
# 2. Filters location data based on configurable criteria
# 3. Sends filtered data to Poke for processing
# 4. Returns the webhook URL for configuration in Owntracks app

on:
  workflow_dispatch:
    inputs:
      update_existing:
        description: 'Update existing workflow if found (by name)'
        required: false
        type: boolean
        default: true
      activate_workflow:
        description: 'Activate the workflow after deployment'
        required: false
        type: boolean
        default: true
      min_accuracy:
        description: 'Minimum GPS accuracy in meters (filter out less accurate)'
        required: false
        type: number
        default: 50
      min_distance:
        description: 'Minimum distance change in meters to send update'
        required: false
        type: number
        default: 20

jobs:
  deploy-owntracks-workflow:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # SETUP
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug Configuration
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” DEPLOYMENT CONFIGURATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "VM_HOST: ${{ secrets.VM_HOST }}"
          echo "VM_USER: ${{ secrets.VM_USER }}"
          echo "Update existing: ${{ inputs.update_existing }}"
          echo "Activate workflow: ${{ inputs.activate_workflow }}"
          echo "Min GPS accuracy: ${{ inputs.min_accuracy }}m"
          echo "Min distance change: ${{ inputs.min_distance }}m"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # SSH SETUP (Same pattern as existing workflows)
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

      - name: Setup SSH
        run: |
          echo "ğŸ” Setting up SSH connection..."
          
          # Create SSH directory
          mkdir -p ~/.ssh
          
          # Decode and save the base64-encoded SSH private key
          echo "${{ secrets.VMSSHPRIVATE_KEY_B64 }}" | base64 -d > ~/.ssh/deploy_key
          
          # Set restrictive permissions on the key (required by SSH)
          chmod 600 ~/.ssh/deploy_key
          
          # Add VM host to known_hosts to avoid host verification prompt
          echo "ğŸ“ Adding VM host to known_hosts..."
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts
          
          # Test SSH connection
          echo "ğŸ”Œ Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "echo 'âœ… SSH connection successful'"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # DETECT N8N INSTALLATION & VERSION
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

      - name: Detect n8n API endpoint and version
        id: detect_n8n
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Detecting n8n installation, API endpoint, and version..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Common n8n ports and paths
          N8N_PORTS=(5678 5679 443 80)
          N8N_API_ENDPOINT=""
          
          for PORT in "${N8N_PORTS[@]}"; do
            echo "ğŸ” Trying port $PORT..."
            
            # Try to access n8n API
            response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" \
              -H "Accept: application/json" \
              "http://${{ secrets.VM_HOST }}:$PORT/api/v1/workflows" 2>/dev/null || echo "HTTP_STATUS:000")
            
            status=$(echo "$response" | tail -n1 | sed 's/HTTP_STATUS://')
            
            # n8n API returns 401 if not authenticated, which means it's there
            if [[ "$status" == "401" ]] || [[ "$status" == "200" ]]; then
              N8N_API_ENDPOINT="http://${{ secrets.VM_HOST }}:$PORT"
              echo "âœ… Found n8n API at: $N8N_API_ENDPOINT"
              echo "   HTTP Status: $status"
              break
            else
              echo "âš ï¸  Port $PORT returned status $status"
            fi
          done
          
          if [ -z "$N8N_API_ENDPOINT" ]; then
            echo "âŒ Could not detect n8n API endpoint"
            echo "   Tried ports: ${N8N_PORTS[@]}"
            echo ""
            echo "ğŸ’¡ Make sure n8n is running and accessible"
            exit 1
          fi
          
          # Try to get n8n version for compatibility checks
          echo ""
          echo "ğŸ” Detecting n8n version..."
          version_response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" \
            -H "Accept: application/json" \
            -H "X-N8N-API-KEY: ${{ secrets.N8N_API_KEY }}" \
            "$N8N_API_ENDPOINT/api/v1/workflows" 2>/dev/null || echo "HTTP_STATUS:000")
          
          version_status=$(echo "$version_response" | tail -n1 | sed 's/HTTP_STATUS://')
          
          if [[ "$version_status" == "200" ]]; then
            echo "âœ… Successfully authenticated with n8n API"
            # Note: Version info might be in response headers or we can infer from API behavior
            echo "   API is accessible and authenticated"
          else
            echo "âš ï¸  Could not authenticate with n8n API (Status: $version_status)"
            echo "   Will proceed with deployment attempt"
          fi
          
          # Set output for next steps
          echo "n8n_api_url=$N8N_API_ENDPOINT" >> $GITHUB_OUTPUT
          echo "n8n_webhook_url=$N8N_API_ENDPOINT" >> $GITHUB_OUTPUT
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # CREATE N8N WORKFLOW JSON (API-COMPLIANT)
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

      - name: Create n8n workflow definition
        id: create_workflow_json
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Creating n8n workflow JSON (API-compliant)..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Create workflow JSON with Owntracks integration
          # This structure follows n8n's API schema (validated properties only)
          # REMOVED: meta, tags, callerPolicy (cause 400 errors)
          # FIXED: env property structure
          cat > /tmp/owntracks_workflow.json << 'WORKFLOW_JSON'
          {
            "name": "Owntracks Location Tracker",
            "nodes": [
              {
                "parameters": {
                  "httpMethod": "POST",
                  "path": "owntracks",
                  "responseMode": "onReceived",
                  "options": {
                    "rawBody": false
                  }
                },
                "id": "webhook-owntracks",
                "name": "Webhook - Owntracks",
                "type": "n8n-nodes-base.webhook",
                "typeVersion": 1,
                "position": [250, 300],
                "webhookId": "owntracks-location"
              },
              {
                "parameters": {
                  "mode": "runOnceForEachItem",
                  "jsCode": "// Owntracks Location Data Filter and Transformer\n// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nconst item = $input.item.json;\nconst MIN_ACCURACY = $env.MIN_ACCURACY || 50;  // meters\nconst MIN_DISTANCE = $env.MIN_DISTANCE || 20;    // meters\n\n// Log incoming data for debugging\nconsole.log('ğŸ“ Received Owntracks data:', JSON.stringify(item, null, 2));\n\n// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n// EXTRACT OWNTRACKS DATA\n// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n// Owntracks sends data in this format:\n// {\n//   \"_type\": \"location\",\n//   \"lat\": 51.5074,\n//   \"lon\": -0.1278,\n//   \"acc\": 10,\n//   \"tst\": 1234567890,\n//   \"alt\": 100,\n//   \"vel\": 0,\n//   \"batt\": 85,\n//   \"tid\": \"JF\",\n//   \"t\": \"u\"\n// }\n\nconst data = {\n  type: item._type || 'location',\n  latitude: item.lat,\n  longitude: item.lon,\n  accuracy: item.acc,\n  timestamp: item.tst,\n  altitude: item.alt,\n  velocity: item.vel,\n  battery: item.batt,\n  tracker_id: item.tid,\n  trigger: item.t  // 'u' = user, 'p' = ping, 't' = timer, etc.\n};\n\n// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n// VALIDATION\n// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nconst validationErrors = [];\n\nif (!data.latitude || !data.longitude) {\n  validationErrors.push('Missing latitude or longitude');\n}\n\nif (data.latitude < -90 || data.latitude > 90) {\n  validationErrors.push('Invalid latitude: ' + data.latitude);\n}\n\nif (data.longitude < -180 || data.longitude > 180) {\n  validationErrors.push('Invalid longitude: ' + data.longitude);\n}\n\nif (validationErrors.length > 0) {\n  console.error('âŒ Validation errors:', validationErrors);\n  return {\n    json: {\n      error: 'Validation failed',\n      details: validationErrors,\n      skip: true\n    }\n  };\n}\n\n// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n// FILTERING LOGIC\n// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nconst shouldSkip = [];\n\n// Filter 1: GPS Accuracy\n// Skip if accuracy is worse than threshold (higher = worse)\nif (data.accuracy && data.accuracy > MIN_ACCURACY) {\n  shouldSkip.push(`Low accuracy: ${data.accuracy}m > ${MIN_ACCURACY}m`);\n}\n\n// Filter 2: Check if this is a significant movement\n// (This would ideally compare with last known position from storage)\n// For now, we'll accept all validated locations\n\n// Filter 3: Ignore certain trigger types if needed\n// For example, skip 'p' (ping) updates if you only want manual/timer\nconst ignoredTriggers = [];  // e.g., ['p'] to ignore pings\nif (data.trigger && ignoredTriggers.includes(data.trigger)) {\n  shouldSkip.push(`Ignored trigger type: ${data.trigger}`);\n}\n\nif (shouldSkip.length > 0) {\n  console.log('â­ï¸  Skipping location update:', shouldSkip);\n  return {\n    json: {\n      skip: true,\n      reason: shouldSkip,\n      data: data\n    }\n  };\n}\n\n// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n// TRANSFORM FOR POKE\n// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n// Convert timestamp to ISO format\nconst timestamp = data.timestamp \n  ? new Date(data.timestamp * 1000).toISOString()\n  : new Date().toISOString();\n\n// Format data for Poke API\nconst pokePayload = {\n  type: 'location_update',\n  source: 'owntracks',\n  timestamp: timestamp,\n  location: {\n    latitude: data.latitude,\n    longitude: data.longitude,\n    accuracy: data.accuracy,\n    altitude: data.altitude,\n    velocity: data.velocity\n  },\n  device: {\n    tracker_id: data.tracker_id,\n    battery: data.battery,\n    trigger: data.trigger\n  },\n  metadata: {\n    raw_timestamp: data.timestamp,\n    processed_at: new Date().toISOString()\n  }\n};\n\nconsole.log('âœ… Location update passed filters');\nconsole.log('ğŸ“¤ Sending to Poke:', JSON.stringify(pokePayload, null, 2));\n\nreturn {\n  json: {\n    skip: false,\n    poke_payload: pokePayload,\n    original_data: data\n  }\n};"
                },
                "id": "filter-location",
                "name": "Filter Location Data",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [450, 300]
              },
              {
                "parameters": {
                  "conditions": {
                    "boolean": [
                      {
                        "value1": "={{ $json.skip }}",
                        "value2": false
                      }
                    ]
                  }
                },
                "id": "check-skip",
                "name": "Should Send?",
                "type": "n8n-nodes-base.if",
                "typeVersion": 1,
                "position": [650, 300]
              },
              {
                "parameters": {
                  "url": "={{ $env.POKE_API_URL || 'http://localhost:8000/api/location' }}",
                  "authentication": "genericCredentialType",
                  "genericAuthType": "httpHeaderAuth",
                  "sendHeaders": true,
                  "headerParameters": {
                    "parameters": [
                      {
                        "name": "Content-Type",
                        "value": "application/json"
                      }
                    ]
                  },
                  "sendBody": true,
                  "bodyParameters": {
                    "parameters": []
                  },
                  "options": {
                    "response": {
                      "response": {
                        "fullResponse": true,
                        "neverError": false
                      }
                    },
                    "timeout": 10000
                  },
                  "method": "POST",
                  "body": "={{ JSON.stringify($json.poke_payload) }}"
                },
                "id": "send-to-poke",
                "name": "Send to Poke",
                "type": "n8n-nodes-base.httpRequest",
                "typeVersion": 4,
                "position": [850, 200],
                "credentials": {
                  "httpHeaderAuth": {
                    "id": "poke-api-key",
                    "name": "Poke API Key"
                  }
                }
              },
              {
                "parameters": {
                  "mode": "runOnceForEachItem",
                  "jsCode": "// Success handler\nconst item = $input.item.json;\n\nconsole.log('âœ… Successfully sent to Poke');\nconsole.log('Response:', JSON.stringify(item, null, 2));\n\nreturn {\n  json: {\n    success: true,\n    status: item.statusCode || 200,\n    message: 'Location update sent to Poke',\n    timestamp: new Date().toISOString()\n  }\n};"
                },
                "id": "log-success",
                "name": "Log Success",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [1050, 200]
              },
              {
                "parameters": {
                  "mode": "runOnceForEachItem",
                  "jsCode": "// Skipped handler\nconst item = $input.item.json;\n\nconsole.log('â­ï¸  Location update skipped');\nconsole.log('Reason:', item.reason || 'No reason provided');\n\nreturn {\n  json: {\n    skipped: true,\n    reason: item.reason,\n    timestamp: new Date().toISOString()\n  }\n};"
                },
                "id": "log-skipped",
                "name": "Log Skipped",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [850, 400]
              },
              {
                "parameters": {
                  "mode": "runOnceForEachItem",
                  "jsCode": "// Error handler\nconst error = $input.item.json;\n\nconsole.error('âŒ Error processing location update');\nconsole.error('Error:', JSON.stringify(error, null, 2));\n\n// Return error details\nreturn {\n  json: {\n    error: true,\n    message: error.message || 'Unknown error',\n    details: error,\n    timestamp: new Date().toISOString()\n  }\n};"
                },
                "id": "handle-error",
                "name": "Handle Error",
                "type": "n8n-nodes-base.code",
                "typeVersion": 2,
                "position": [1050, 300]
              }
            ],
            "connections": {
              "Webhook - Owntracks": {
                "main": [
                  [
                    {
                      "node": "Filter Location Data",
                      "type": "main",
                      "index": 0
                    }
                  ]
                ]
              },
              "Filter Location Data": {
                "main": [
                  [
                    {
                      "node": "Should Send?",
                      "type": "main",
                      "index": 0
                    }
                  ]
                ]
              },
              "Should Send?": {
                "main": [
                  [
                    {
                      "node": "Send to Poke",
                      "type": "main",
                      "index": 0
                    }
                  ],
                  [
                    {
                      "node": "Log Skipped",
                      "type": "main",
                      "index": 0
                    }
                  ]
                ]
              },
              "Send to Poke": {
                "main": [
                  [
                    {
                      "node": "Log Success",
                      "type": "main",
                      "index": 0
                    }
                  ]
                ]
              }
            },
            "settings": {
              "executionOrder": "v1",
              "saveManualExecutions": true,
              "errorWorkflow": ""
            },
            "staticData": null
          }
          WORKFLOW_JSON
          
          echo "âœ… Workflow JSON created at /tmp/owntracks_workflow.json"
          echo ""
          echo "ğŸ“Š Workflow Summary:"
          echo "   Name: Owntracks Location Tracker"
          echo "   Nodes: 7"
          echo "   - Webhook (POST /owntracks)"
          echo "   - Filter/Transform (JavaScript)"
          echo "   - Conditional routing"
          echo "   - HTTP Request to Poke"
          echo "   - Success/Error/Skip handlers"
          echo ""
          echo "ğŸ”§ API Compliance:"
          echo "   âœ… Removed 'meta' object (not in n8n API schema)"
          echo "   âœ… Removed 'tags' array (not accepted in create/update)"
          echo "   âœ… Removed 'callerPolicy' from settings"
          echo "   âœ… Simplified settings structure"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # CHECK FOR EXISTING WORKFLOW
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

      - name: Check for existing workflow
        id: check_existing
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Checking for existing 'Owntracks Location Tracker' workflow..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          N8N_API="${{ steps.detect_n8n.outputs.n8n_api_url }}/api/v1"
          
          # List all workflows
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" \
            -H "Accept: application/json" \
            -H "X-N8N-API-KEY: ${{ secrets.N8N_API_KEY }}" \
            "$N8N_API/workflows" 2>/dev/null || echo "HTTP_STATUS:000")
          
          status=$(echo "$response" | tail -n1 | sed 's/HTTP_STATUS://')
          body=$(echo "$response" | sed '$d')
          
          echo "API Response Status: $status"
          
          if [[ "$status" == "200" ]]; then
            echo "âœ… Successfully retrieved workflows"
            
            # Parse JSON to find workflow by name
            # Note: This requires jq, which is available in GitHub Actions
            existing_id=$(echo "$body" | jq -r '.data[] | select(.name == "Owntracks Location Tracker") | .id' || echo "")
            
            if [ ! -z "$existing_id" ]; then
              echo "ğŸ“ Found existing workflow with ID: $existing_id"
              echo "existing_workflow_id=$existing_id" >> $GITHUB_OUTPUT
              echo "workflow_exists=true" >> $GITHUB_OUTPUT
            else
              echo "ğŸ“ No existing workflow found"
              echo "workflow_exists=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸  Could not retrieve workflows (Status: $status)"
            echo "Response: $body"
            echo "workflow_exists=false" >> $GITHUB_OUTPUT
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # DEPLOY WORKFLOW TO N8N (WITH DEBUG OUTPUT)
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

      - name: Deploy workflow to n8n
        id: deploy_workflow
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Deploying workflow to n8n..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          N8N_API="${{ steps.detect_n8n.outputs.n8n_api_url }}/api/v1"
          WORKFLOW_JSON=$(cat /tmp/owntracks_workflow.json)
          
          # Inject environment variables into workflow settings
          # Note: env vars are set at workflow level, not in settings object
          WORKFLOW_JSON=$(echo "$WORKFLOW_JSON" | jq \
            --arg min_acc "${{ inputs.min_accuracy }}" \
            --arg min_dist "${{ inputs.min_distance }}" \
            '. + {
              "settings": (.settings + {
                "executionOrder": "v1",
                "saveManualExecutions": true,
                "errorWorkflow": ""
              })
            }')
          
          echo "ğŸ“ Workflow configuration:"
          echo "   MIN_ACCURACY: ${{ inputs.min_accuracy }}m"
          echo "   MIN_DISTANCE: ${{ inputs.min_distance }}m"
          echo ""
          
          # Determine if we're creating or updating
          if [[ "${{ steps.check_existing.outputs.workflow_exists }}" == "true" ]] && [[ "${{ inputs.update_existing }}" == "true" ]]; then
            WORKFLOW_ID="${{ steps.check_existing.outputs.existing_workflow_id }}"
            METHOD="PATCH"
            ENDPOINT="$N8N_API/workflows/$WORKFLOW_ID"
            echo "ğŸ”„ Updating existing workflow (ID: $WORKFLOW_ID)"
          else
            METHOD="POST"
            ENDPOINT="$N8N_API/workflows"
            echo "âœ¨ Creating new workflow"
          fi
          
          echo ""
          echo "ğŸ“¤ Sending workflow to n8n..."
          echo "   Method: $METHOD"
          echo "   Endpoint: $ENDPOINT"
          echo ""
          
          # Debug: Show exact JSON being sent (first 1000 chars)
          echo "ğŸ” DEBUG: Request payload (truncated):"
          echo "$WORKFLOW_JSON" | jq '.' | head -n 50
          echo "..."
          echo ""
          
          # Debug: Show JSON structure summary
          echo "ğŸ” DEBUG: Payload structure:"
          echo "$WORKFLOW_JSON" | jq 'keys'
          echo ""
          echo "ğŸ” DEBUG: Settings structure:"
          echo "$WORKFLOW_JSON" | jq '.settings | keys'
          echo ""
          echo "ğŸ” DEBUG: Node count:"
          echo "$WORKFLOW_JSON" | jq '.nodes | length'
          echo ""
          
          # Deploy workflow
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" \
            -X "$METHOD" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "X-N8N-API-KEY: ${{ secrets.N8N_API_KEY }}" \
            -d "$WORKFLOW_JSON" \
            "$ENDPOINT" 2>/dev/null || echo "HTTP_STATUS:000")
          
          status=$(echo "$response" | tail -n1 | sed 's/HTTP_STATUS://')
          body=$(echo "$response" | sed '$d')
          
          echo "API Response Status: $status"
          echo ""
          
          if [[ "$status" == "200" ]] || [[ "$status" == "201" ]]; then
            echo "âœ… Workflow deployed successfully!"
            
            # Extract workflow ID from response
            workflow_id=$(echo "$body" | jq -r '.data.id // .id')
            workflow_name=$(echo "$body" | jq -r '.data.name // .name')
            
            echo "   Workflow ID: $workflow_id"
            echo "   Workflow Name: $workflow_name"
            
            # Set outputs
            echo "workflow_id=$workflow_id" >> $GITHUB_OUTPUT
            echo "workflow_name=$workflow_name" >> $GITHUB_OUTPUT
            
          else
            echo "âŒ Failed to deploy workflow"
            echo "   Status: $status"
            echo ""
            echo "ğŸ” DEBUG: Full error response:"
            echo "$body" | jq '.' || echo "$body"
            echo ""
            echo "ğŸ’¡ Common causes of 400 errors:"
            echo "   - Additional properties not allowed by n8n API schema"
            echo "   - Invalid node configuration"
            echo "   - Missing required fields"
            echo "   - Incorrect data types"
            exit 1
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # SET ENVIRONMENT VARIABLES IN N8N
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

      - name: Set workflow environment variables
        id: set_env_vars
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš™ï¸  Setting workflow environment variables..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Note: Environment variables in n8n workflows are typically set via:
          # 1. Global environment variables (set in n8n settings)
          # 2. Workflow-specific settings (if supported by n8n version)
          # 3. Passed through the workflow execution context
          
          echo "ğŸ“ Configuration values to set in n8n manually or via environment:"
          echo "   MIN_ACCURACY=${{ inputs.min_accuracy }}"
          echo "   MIN_DISTANCE=${{ inputs.min_distance }}"
          echo "   POKE_API_URL=<to be configured>"
          echo ""
          echo "ğŸ’¡ These values are referenced in the JavaScript code nodes"
          echo "   and can be set in n8n's global environment variables or"
          echo "   passed through workflow settings if your n8n version supports it"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ACTIVATE WORKFLOW
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

      - name: Activate workflow
        if: ${{ inputs.activate_workflow }}
        id: activate_workflow
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš¡ Activating workflow..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          N8N_API="${{ steps.detect_n8n.outputs.n8n_api_url }}/api/v1"
          WORKFLOW_ID="${{ steps.deploy_workflow.outputs.workflow_id }}"
          
          # Activate workflow by updating its active status
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" \
            -X PATCH \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "X-N8N-API-KEY: ${{ secrets.N8N_API_KEY }}" \
            -d '{"active": true}' \
            "$N8N_API/workflows/$WORKFLOW_ID" 2>/dev/null || echo "HTTP_STATUS:000")
          
          status=$(echo "$response" | tail -n1 | sed 's/HTTP_STATUS://')
          body=$(echo "$response" | sed '$d')
          
          echo "API Response Status: $status"
          
          if [[ "$status" == "200" ]] || [[ "$status" == "201" ]]; then
            echo "âœ… Workflow activated successfully!"
            is_active=$(echo "$body" | jq -r '.data.active // .active')
            echo "   Active status: $is_active"
          else
            echo "âš ï¸  Failed to activate workflow"
            echo "   Status: $status"
            echo "   Response: $body"
            echo "   (Workflow was deployed but not activated)"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # GET WEBHOOK URL
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

      - name: Get webhook URL
        id: get_webhook_url
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”— Retrieving webhook URL..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          N8N_BASE_URL="${{ steps.detect_n8n.outputs.n8n_webhook_url }}"
          WORKFLOW_ID="${{ steps.deploy_workflow.outputs.workflow_id }}"
          
          # Construct webhook URL
          # n8n webhook URLs follow the pattern: http://host:port/webhook/path
          # or http://host:port/webhook-test/path for test webhooks
          
          WEBHOOK_PATH="owntracks"
          WEBHOOK_URL_PROD="$N8N_BASE_URL/webhook/$WEBHOOK_PATH"
          WEBHOOK_URL_TEST="$N8N_BASE_URL/webhook-test/$WEBHOOK_PATH"
          
          echo "ğŸ“ Production Webhook URL:"
          echo "   $WEBHOOK_URL_PROD"
          echo ""
          echo "ğŸ§ª Test Webhook URL:"
          echo "   $WEBHOOK_URL_TEST"
          echo ""
          
          # Set outputs
          echo "webhook_url_prod=$WEBHOOK_URL_PROD" >> $GITHUB_OUTPUT
          echo "webhook_url_test=$WEBHOOK_URL_TEST" >> $GITHUB_OUTPUT
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # TEST WEBHOOK
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

      - name: Test webhook
        continue-on-error: true
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§ª Testing webhook with sample Owntracks data..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          WEBHOOK_URL="${{ steps.get_webhook_url.outputs.webhook_url_test }}"
          
          # Sample Owntracks location payload
          cat > /tmp/test_payload.json << 'TEST_PAYLOAD'
          {
            "_type": "location",
            "lat": 48.8566,
            "lon": 2.3522,
            "acc": 10,
            "tst": 1708290000,
            "alt": 35,
            "vel": 0,
            "batt": 85,
            "tid": "JF",
            "t": "u"
          }
          TEST_PAYLOAD
          
          echo "ğŸ“¤ Sending test payload:"
          cat /tmp/test_payload.json | jq .
          echo ""
          
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" \
            -X POST \
            -H "Content-Type: application/json" \
            -d @/tmp/test_payload.json \
            "$WEBHOOK_URL" 2>/dev/null || echo "HTTP_STATUS:000")
          
          status=$(echo "$response" | tail -n1 | sed 's/HTTP_STATUS://')
          body=$(echo "$response" | sed '$d')
          
          echo "Webhook Response Status: $status"
          echo "Response Body: $body"
          
          if [[ "$status" == "200" ]] || [[ "$status" == "201" ]]; then
            echo "âœ… Webhook test successful!"
          else
            echo "âš ï¸  Webhook test returned status $status"
            echo "   This might be expected if the workflow requires activation first"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # CLEANUP
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

      - name: Cleanup SSH keys
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up SSH keys..."
          rm -f ~/.ssh/deploy_key
          echo "âœ… Cleanup complete"

      - name: Cleanup temporary files
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up temporary files..."
          rm -f /tmp/owntracks_workflow.json
          rm -f /tmp/test_payload.json
          echo "âœ… Cleanup complete"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # DEPLOYMENT SUMMARY
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

      - name: Deployment summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Workflow Details:"
          echo "   Name: ${{ steps.deploy_workflow.outputs.workflow_name }}"
          echo "   ID: ${{ steps.deploy_workflow.outputs.workflow_id }}"
          echo "   Status: ${{ inputs.activate_workflow && 'Active' || 'Inactive' }}"
          echo ""
          echo "ğŸ”— Webhook URLs:"
          echo "   Production: ${{ steps.get_webhook_url.outputs.webhook_url_prod }}"
          echo "   Test: ${{ steps.get_webhook_url.outputs.webhook_url_test }}"
          echo ""
          echo "âš™ï¸  Configuration:"
          echo "   Min GPS Accuracy: ${{ inputs.min_accuracy }}m"
          echo "   Min Distance Change: ${{ inputs.min_distance }}m"
          echo ""
          echo "ğŸ“± Owntracks Configuration:"
          echo "   1. Open Owntracks app"
          echo "   2. Go to Settings â†’ Connection"
          echo "   3. Set Mode: HTTP"
          echo "   4. Set URL: ${{ steps.get_webhook_url.outputs.webhook_url_prod }}"
          echo "   5. Set Method: POST"
          echo "   6. (Optional) Add authentication if configured"
          echo ""
          echo "ğŸ”§ Next Steps:"
          echo "   1. Configure Poke API endpoint in n8n workflow settings"
          echo "      Environment variable: POKE_API_URL"
          echo "   2. Set up Poke API authentication credentials in n8n"
          echo "   3. Test the integration by sending a location update from Owntracks"
          echo "   4. Monitor n8n execution logs for any issues"
          echo ""
          echo "ğŸ“ Environment Variables needed in n8n:"
          echo "   - MIN_ACCURACY: ${{ inputs.min_accuracy }} (filter locations with accuracy > this value)"
          echo "   - MIN_DISTANCE: ${{ inputs.min_distance }} (minimum distance change to send update)"
          echo "   - POKE_API_URL: Poke API endpoint for location updates"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Deployment failure notice
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ DEPLOYMENT FAILED!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Please check the logs above for details."
          echo ""
          echo "Common issues:"
          echo "   1. N8N_API_KEY secret not set or invalid"
          echo "   2. n8n API not accessible"
          echo "   3. Invalid workflow JSON structure"
          echo "   4. n8n not running on VM"
          echo "   5. Additional properties in JSON not allowed by n8n API"
          echo ""
          echo "Troubleshooting:"
          echo "   - Verify N8N_API_KEY is set in GitHub Secrets"
          echo "   - Check n8n is running: ssh ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}"
          echo "   - Test n8n API manually: curl -H 'X-N8N-API-KEY: YOUR_KEY' http://VM_HOST:5678/api/v1/workflows"
          echo "   - Review n8n logs for errors"
          echo "   - Check the debug output above for API response details"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1
