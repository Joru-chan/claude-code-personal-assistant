name: Deploy to VM

on:
  push:
    branches: [main]
    paths:
      - 'vm_server/**'
      - 'vm/deploy.sh'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      restart_only:
        description: 'Restart only (skip rsync and dependency sync)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug SSH Key
        run: |
          echo "Key starts with: $(echo "${{ secrets.VMSSHPRIVATE_KEY }}" | head -c 20)"
          echo "VM_HOST: ${{ secrets.VM_HOST }}"
          echo "VM_USER: ${{ secrets.VM_USER }}"

      - name: Setup SSH
        run: |
          echo "ğŸ” Setting up SSH connection..."
          mkdir -p ~/.ssh
          echo "${{ secrets.VMSSHPRIVATE_KEY_B64 }}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add VM host to known_hosts
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts
          
          # Test SSH connection
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "echo 'âœ… SSH connection successful'"

      - name: Debug Rsync Variables
        if: ${{ !inputs.restart_only }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” DEBUGGING RSYNC CONFIGURATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "VM_USER is set: ${{ secrets.VM_USER != '' }}"
          echo "VM_HOST is set: ${{ secrets.VM_HOST != '' }}"
          echo "VM_DEST_DIR is set: ${{ secrets.VM_DEST_DIR != '' }}"
          echo ""
          echo "VM_USER length: $(echo -n '${{ secrets.VM_USER }}' | wc -c) characters"
          echo "VM_HOST length: $(echo -n '${{ secrets.VM_HOST }}' | wc -c) characters"
          echo "VM_DEST_DIR length: $(echo -n '${{ secrets.VM_DEST_DIR }}' | wc -c) characters"
          echo ""
          echo "Full rsync target path will be:"
          echo "${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:${{ secrets.VM_DEST_DIR }}/"
          echo ""
          echo "VM_DEST_DIR starts with: $(echo '${{ secrets.VM_DEST_DIR }}' | cut -c1-10)..."
          echo "VM_DEST_DIR ends with: ...$(echo '${{ secrets.VM_DEST_DIR }}' | tail -c 10)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Verify remote directory
        if: ${{ !inputs.restart_only }}
        run: |
          echo "ğŸ” Verifying remote directory structure..."
          
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "echo 'Current user: \$(whoami)'; \
             echo 'Home directory: \$HOME'; \
             echo 'Target directory: ${{ secrets.VM_DEST_DIR }}'; \
             echo ''; \
             echo 'Checking if directory exists:'; \
             if [ -d '${{ secrets.VM_DEST_DIR }}' ]; then \
               echo 'âœ… Directory exists'; \
               ls -la '${{ secrets.VM_DEST_DIR }}' | head -n 10; \
               echo ''; \
               echo 'Directory permissions:'; \
               stat -c '%A %U:%G' '${{ secrets.VM_DEST_DIR }}'; \
             else \
               echo 'âŒ Directory does NOT exist'; \
               echo 'Attempting to create it...'; \
               mkdir -p '${{ secrets.VM_DEST_DIR }}' && echo 'âœ… Directory created' || echo 'âŒ Failed to create directory'; \
             fi"

      - name: Sync code to VM
        if: ${{ !inputs.restart_only }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Starting rsync deployment..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Source: vm_server/"
          echo "Target: ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:${{ secrets.VM_DEST_DIR }}/"
          echo ""
          
          rsync -avvz --progress \
            --exclude='venv/' \
            --exclude='__pycache__/' \
            --exclude='*.pyc' \
            --exclude='*.bak*' \
            --exclude='*~' \
            --exclude='.env' \
            --exclude='memory/' \
            --exclude='.git/' \
            -e "ssh -i ~/.ssh/deploy_key" \
            vm_server/ ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:${{ secrets.VM_DEST_DIR }}/
          
          rsync_exit_code=$?
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ $rsync_exit_code -eq 0 ]; then
            echo "âœ… Rsync completed successfully (exit code: $rsync_exit_code)"
          else
            echo "âŒ Rsync failed with exit code: $rsync_exit_code"
            exit $rsync_exit_code
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Install dependencies
        if: ${{ !inputs.restart_only }}
        run: |
          echo "ğŸ“š Installing Python dependencies..."
          
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "if [ -f '${{ secrets.VM_DEST_DIR }}/requirements.txt' ]; then \
              echo 'Found requirements.txt, installing dependencies...'; \
              ${{ secrets.VM_VENV_PY }} -m pip install --upgrade pip && \
              ${{ secrets.VM_VENV_PY }} -m pip install -r '${{ secrets.VM_DEST_DIR }}/requirements.txt'; \
              echo 'âœ… Dependencies installed'; \
            else \
              echo 'âš ï¸  No requirements.txt found, skipping dependency installation'; \
            fi"

      - name: Restart service
        run: |
          echo "ğŸ”„ Restarting ${{ secrets.VM_SERVICE }}..."
          
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "sudo systemctl daemon-reload && sudo systemctl restart ${{ secrets.VM_SERVICE }}"
          
          echo "âœ… Service restart command sent"
          echo "â³ Waiting 5 seconds for service to initialize..."
          sleep 5

      - name: Verify service status
        run: |
          echo "ğŸ” Checking service status..."
          
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "sudo systemctl is-active ${{ secrets.VM_SERVICE }} && \
             echo 'âœ… Service is active' || \
             (echo 'âŒ Service is not active' && \
              sudo systemctl status ${{ secrets.VM_SERVICE }} && \
              exit 1)"

      - name: MCP health check
        run: |
          echo "ğŸ¥ Running MCP health check..."
          
          max_attempts=10
          attempt=0
          success=false
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts..."
            
            response=$(curl -sS -w "\nHTTP_STATUS:%{http_code}\n" \
              -H "Content-Type: application/json" \
              -H "Accept: application/json, text/event-stream" \
              -d '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"health_check","arguments":{}}}' \
              "${{ secrets.VM_MCP_URL }}" || echo "HTTP_STATUS:000")
            
            status=$(echo "$response" | tail -n1 | sed 's/HTTP_STATUS://')
            body=$(echo "$response" | sed '$d')
            
            if [[ "$status" == 2* ]]; then
              echo "âœ… MCP health check successful (HTTP $status)"
              echo "Response: $(echo "$body" | head -n1)"
              success=true
              break
            else
              echo "âš ï¸  MCP returned status $status"
              if [ $attempt -lt $max_attempts ]; then
                echo "Retrying in 2 seconds..."
                sleep 2
              fi
            fi
          done
          
          if [ "$success" = false ]; then
            echo "âŒ MCP health check failed after $max_attempts attempts"
            exit 1
          fi

      - name: HTTP health check (fallback)
        if: failure()
        run: |
          echo "ğŸ¥ Running HTTP health check (fallback)..."
          
          response=$(curl -sS -w "\nHTTP_STATUS:%{http_code}\n" \
            "${{ secrets.VM_HEALTH_URL }}" || echo "HTTP_STATUS:000")
          
          status=$(echo "$response" | tail -n1 | sed 's/HTTP_STATUS://')
          body=$(echo "$response" | sed '$d')
          
          if [[ "$status" == 2* ]]; then
            echo "âœ… HTTP health check successful (HTTP $status)"
            echo "Response: $body"
          else
            echo "âŒ HTTP health check failed (HTTP $status)"
            echo "Response: $body"
            exit 1
          fi

      - name: Cleanup SSH keys
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up SSH keys..."
          rm -f ~/.ssh/deploy_key
          echo "âœ… Cleanup complete"

      - name: Deployment summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Deployment completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Target: ${{ secrets.VM_HOST }}"
          echo "ğŸ“‚ Directory: ${{ secrets.VM_DEST_DIR }}"
          echo "ğŸ”§ Service: ${{ secrets.VM_SERVICE }}"
          echo "ğŸŒ MCP URL: ${{ secrets.VM_MCP_URL }}"
          echo "ğŸ’š Health URL: ${{ secrets.VM_HEALTH_URL }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Deployment failure notice
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Deployment failed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Please check the logs above for details."
          echo "You may need to manually investigate the VM."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1
