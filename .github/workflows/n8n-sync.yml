name: N8N Workflow Sync

on:
  workflow_dispatch:
    inputs:
      sync_direction:
        description: 'Sync Direction'
        required: true
        type: choice
        options:
          - push
          - pull
      workflow_name:
        description: 'Workflow Name (leave blank to sync ALL workflows)'
        required: false
        type: string
        default: ''
      auth_method:
        description: 'Authentication Method'
        required: false
        type: choice
        options:
          - auto
          - api_key
          - token
        default: 'auto'
      debug_mode:
        description: 'Enable debug output'
        required: false
        type: boolean
        default: false

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Validate configuration
        run: |
          echo "üîç Validating configuration..."
          
          if [ -z "${{ secrets.N8N_BASE_URL }}" ]; then
            echo "‚ùå ERROR: N8N_BASE_URL secret is not set"
            echo "Please add N8N_BASE_URL to your repository secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.N8N_API_KEY }}" ]; then
            echo "‚ùå ERROR: N8N_API_KEY secret is not set"
            echo "Please add N8N_API_KEY to your repository secrets"
            exit 1
          fi
          
          echo "‚úÖ Configuration validated"
          
          # Store variables for reuse
          BASE_URL="${{ secrets.N8N_BASE_URL }}"
          BASE_URL="${BASE_URL%/}"  # Remove trailing slash
          echo "N8N_BASE_URL_CLEAN=${BASE_URL}" >> $GITHUB_ENV
          echo "AUTH_METHOD=${{ github.event.inputs.auth_method || 'auto' }}" >> $GITHUB_ENV
          echo "DEBUG_MODE=${{ github.event.inputs.debug_mode || 'false' }}" >> $GITHUB_ENV
          
          if [ "${{ github.event.inputs.debug_mode || 'false' }}" == "true" ]; then
            echo "üêõ Debug mode enabled"
            echo "Base URL: ${BASE_URL}"
            echo "Auth Method: ${{ github.event.inputs.auth_method || 'auto' }}"
          fi

      - name: Test n8n connection and detect authentication method
        run: |
          echo "üîó Testing n8n connection and detecting authentication method..."
          
          BASE_URL="${N8N_BASE_URL_CLEAN}"
          API_KEY="${{ secrets.N8N_API_KEY }}"
          
          # Function to test API with different auth methods
          test_auth() {
            local method=$1
            local header=$2
            local test_name=$3
            
            echo "üß™ Testing $test_name..."
            
            if [ "$DEBUG_MODE" == "true" ]; then
              echo "Debug: curl -s -w '%{http_code}' -o response.json -H 'accept: application/json' -H '$header' '$BASE_URL/api/v1/workflows'"
            fi
            
            HTTP_CODE=$(curl -s -w '%{http_code}' -o response.json -H "accept: application/json" -H "$header" "$BASE_URL/api/v1/workflows")
            
            echo "HTTP Status: $HTTP_CODE"
            
            if [ "$DEBUG_MODE" == "true" ]; then
              echo "Response body:"
              cat response.json | jq '.' 2>/dev/null || cat response.json
              echo ""
            fi
            
            case $HTTP_CODE in
              200)
                echo "‚úÖ $test_name authentication successful!"
                echo "WORKING_AUTH_METHOD=$method" >> $GITHUB_ENV
                echo "WORKING_AUTH_HEADER=$header" >> $GITHUB_ENV
                return 0
                ;;
              401)
                echo "‚ùå $test_name failed: 401 Authentication Failed"
                if [ "$DEBUG_MODE" == "true" ]; then
                  echo "This usually means the API key/token is invalid or has insufficient permissions"
                fi
                return 1
                ;;
              403)
                echo "‚ùå $test_name failed: 403 Forbidden"
                echo "The API key/token may not have sufficient permissions"
                return 1
                ;;
              404)
                echo "‚ùå $test_name failed: 404 Not Found"
                echo "The n8n API endpoint was not found. Check your base URL: $BASE_URL"
                echo "Expected format: https://your-n8n-instance.com (without /api/v1/workflows)"
                return 1
                ;;
              *)
                echo "‚ùå $test_name failed: HTTP $HTTP_CODE"
                echo "Response:"
                cat response.json
                return 1
                ;;
            esac
          }
          
          # Test different authentication methods based on user input
          AUTH_SUCCESS=false
          
          if [ "$AUTH_METHOD" == "auto" ] || [ "$AUTH_METHOD" == "api_key" ]; then
            echo "Testing X-N8N-API-KEY authentication..."
            if test_auth "api_key" "X-N8N-API-KEY: $API_KEY" "API Key (X-N8N-API-KEY)"; then
              AUTH_SUCCESS=true
            fi
          fi
          
          if [ "$AUTH_SUCCESS" == "false" ] && ([ "$AUTH_METHOD" == "auto" ] || [ "$AUTH_METHOD" == "token" ]); then
            echo "Testing Authorization Bearer token authentication..."
            if test_auth "token" "Authorization: Bearer $API_KEY" "Bearer Token"; then
              AUTH_SUCCESS=true
            fi
          fi
          
          if [ "$AUTH_SUCCESS" == "false" ]; then
            echo "‚ùå All authentication methods failed!"
            echo ""
            echo "üîß Troubleshooting steps:"
            echo "1. Verify N8N_API_KEY is correctly set in repository secrets"
            echo "2. Verify N8N_BASE_URL is accessible and correct (current: $BASE_URL)"
            echo "3. Check if your n8n instance requires different authentication"
            echo "4. Ensure the API key has proper permissions in n8n"
            echo "5. Try running with debug_mode: true for more details"
            echo ""
            echo "Expected n8n API endpoint: $BASE_URL/api/v1/workflows"
            exit 1
          fi
          
          echo "üéâ Authentication method '$WORKING_AUTH_METHOD' is working!"

      - name: Get n8n version info
        run: |
          echo "üìã Getting n8n instance information..."
          
          BASE_URL="${N8N_BASE_URL_CLEAN}"
          AUTH_HEADER="${WORKING_AUTH_HEADER}"
          
          # Get n8n version and health info
          echo "Getting version info..."
          HTTP_CODE=$(curl -s -w '%{http_code}' -o version.json -H "accept: application/json" -H "$AUTH_HEADER" "$BASE_URL/api/v1/workflows")
          
          if [ "$HTTP_CODE" == "200" ]; then
            echo "‚úÖ n8n API is accessible"
            if [ "$DEBUG_MODE" == "true" ]; then
              echo "Workflows response:"
              cat version.json | jq '.' 2>/dev/null || cat version.json
            fi
          else
            echo "‚ö†Ô∏è  Could not get version info (HTTP $HTTP_CODE), but authentication works"
          fi

      - name: Pull workflows from n8n
        if: github.event.inputs.sync_direction == 'pull'
        run: |
          echo "‚¨áÔ∏è  Pulling workflows from n8n..."
          
          BASE_URL="${N8N_BASE_URL_CLEAN}"
          AUTH_HEADER="${WORKING_AUTH_HEADER}"
          WORKFLOW_NAME="${{ github.event.inputs.workflow_name }}"
          
          mkdir -p workflows
          
          # Get list of workflows
          echo "Getting workflow list..."
          HTTP_CODE=$(curl -s -w '%{http_code}' -o workflows_list.json -H "accept: application/json" -H "$AUTH_HEADER" "$BASE_URL/api/v1/workflows")
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Failed to get workflows list (HTTP $HTTP_CODE)"
            cat workflows_list.json
            exit 1
          fi
          
          if [ "$DEBUG_MODE" == "true" ]; then
            echo "Workflows list response:"
            cat workflows_list.json | jq '.' 2>/dev/null || cat workflows_list.json
          fi
          
          # Process workflows
          WORKFLOW_COUNT=0
          SUCCESS_COUNT=0
          
          if [ -n "$WORKFLOW_NAME" ]; then
            echo "Syncing specific workflow: $WORKFLOW_NAME"
            WORKFLOW_ID=$(cat workflows_list.json | jq -r ".data[] | select(.name == \"$WORKFLOW_NAME\") | .id" 2>/dev/null)
            if [ "$WORKFLOW_ID" != "null" ] && [ -n "$WORKFLOW_ID" ]; then
              echo "Found workflow ID: $WORKFLOW_ID"
              WORKFLOWS_TO_SYNC="$WORKFLOW_ID:$WORKFLOW_NAME"
              WORKFLOW_COUNT=1
            else
              echo "‚ùå Workflow '$WORKFLOW_NAME' not found in n8n"
              exit 1
            fi
          else
            echo "Syncing all workflows..."
            WORKFLOWS_TO_SYNC=$(cat workflows_list.json | jq -r '.data[] | "\(.id):\(.name)"' 2>/dev/null)
            WORKFLOW_COUNT=$(echo "$WORKFLOWS_TO_SYNC" | wc -l)
          fi
          
          echo "Found $WORKFLOW_COUNT workflow(s) to sync"
          
          # Download each workflow
          echo "$WORKFLOWS_TO_SYNC" | while IFS=':' read -r workflow_id workflow_name; do
            if [ -z "$workflow_id" ] || [ "$workflow_id" == "null" ]; then
              continue
            fi
            
            echo "üì• Downloading: $workflow_name (ID: $workflow_id)"
            
            HTTP_CODE=$(curl -s -w '%{http_code}' -o "workflow_temp.json" -H "accept: application/json" -H "$AUTH_HEADER" "$BASE_URL/api/v1/workflows/$workflow_id")
            
            if [ "$HTTP_CODE" == "200" ]; then
              # Clean filename for filesystem
              SAFE_NAME=$(echo "$workflow_name" | sed 's/[^a-zA-Z0-9._-]/_/g')
              OUTPUT_FILE="workflows/${SAFE_NAME}.json"
              
              # Format the JSON nicely
              cat workflow_temp.json | jq '.' > "$OUTPUT_FILE" 2>/dev/null || cp workflow_temp.json "$OUTPUT_FILE"
              
              echo "  ‚úÖ Saved: $OUTPUT_FILE"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "  ‚ùå Failed to download (HTTP $HTTP_CODE)"
              if [ "$DEBUG_MODE" == "true" ]; then
                cat workflow_temp.json
              fi
            fi
          done
          
          rm -f workflow_temp.json workflows_list.json
          echo "‚úÖ Successfully downloaded $SUCCESS_COUNT/$WORKFLOW_COUNT workflows"

      - name: Push workflows to n8n
        if: github.event.inputs.sync_direction == 'push'
        run: |
          echo "‚¨ÜÔ∏è  Pushing workflows to n8n..."
          
          BASE_URL="${N8N_BASE_URL_CLEAN}"
          AUTH_HEADER="${WORKING_AUTH_HEADER}"
          WORKFLOW_NAME="${{ github.event.inputs.workflow_name }}"
          
          if [ ! -d "workflows" ]; then
            echo "‚ùå No workflows directory found"
            exit 1
          fi
          
          # Get existing workflows from n8n
          echo "Getting existing workflows..."
          HTTP_CODE=$(curl -s -w '%{http_code}' -o workflows_list.json -H "accept: application/json" -H "$AUTH_HEADER" "$BASE_URL/api/v1/workflows")
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Failed to get workflows list (HTTP $HTTP_CODE)"
            cat workflows_list.json
            exit 1
          fi
          
          SUCCESS_COUNT=0
          TOTAL_COUNT=0
          
          for workflow_file in workflows/*.json; do
            if [ ! -f "$workflow_file" ]; then
              continue
            fi
            
            WORKFLOW_NAME_FROM_FILE=$(basename "$workflow_file" .json)
            
            # Skip if specific workflow requested and this isn't it
            if [ -n "$WORKFLOW_NAME" ] && [ "$WORKFLOW_NAME_FROM_FILE" != "$WORKFLOW_NAME" ]; then
              continue
            fi
            
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            echo "üì§ Processing: $WORKFLOW_NAME_FROM_FILE"
            
            # Get workflow name from JSON
            JSON_NAME=$(cat "$workflow_file" | jq -r '.name' 2>/dev/null)
            if [ "$JSON_NAME" == "null" ] || [ -z "$JSON_NAME" ]; then
              JSON_NAME="$WORKFLOW_NAME_FROM_FILE"
            fi
            
            # Strip extra properties that n8n API doesn't accept
            # Only keep the properties that n8n API accepts
            echo "  üßπ Cleaning workflow data..."
            cat "$workflow_file" | jq '{
              name: .name,
              nodes: .nodes,
              connections: .connections,
              settings: .settings,
              staticData: .staticData,
              active: .active,
              tags: .tags
            }' > workflow_clean.json
            
            if [ "$DEBUG_MODE" == "true" ]; then
              echo "  Original workflow properties:"
              cat "$workflow_file" | jq 'keys' 2>/dev/null
              echo "  Cleaned workflow properties:"
              cat workflow_clean.json | jq 'keys' 2>/dev/null
            fi
            
            # Check if workflow exists in n8n
            EXISTING_ID=$(cat workflows_list.json | jq -r ".data[] | select(.name == \"$JSON_NAME\") | .id" 2>/dev/null)
            
            if [ "$EXISTING_ID" != "null" ] && [ -n "$EXISTING_ID" ]; then
              echo "  üîÑ Updating existing workflow (ID: $EXISTING_ID)"
              HTTP_CODE=$(curl -s -w '%{http_code}' -o response.json -X PUT -H "accept: application/json" -H "$AUTH_HEADER" -H "Content-Type: application/json" -d @workflow_clean.json "$BASE_URL/api/v1/workflows/$EXISTING_ID")
            else
              echo "  ‚ûï Creating new workflow"
              HTTP_CODE=$(curl -s -w '%{http_code}' -o response.json -X POST -H "accept: application/json" -H "$AUTH_HEADER" -H "Content-Type: application/json" -d @workflow_clean.json "$BASE_URL/api/v1/workflows")
            fi
            
            if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "201" ]; then
              echo "  ‚úÖ Success (HTTP $HTTP_CODE)"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "  ‚ùå Failed (HTTP $HTTP_CODE)"
              echo "  Response:"
              cat response.json
              if [ "$DEBUG_MODE" == "true" ]; then
                echo "  Cleaned payload that was sent:"
                cat workflow_clean.json | jq '.'
              fi
            fi
          done
          
          rm -f workflows_list.json response.json workflow_clean.json
          echo "‚úÖ Successfully pushed $SUCCESS_COUNT/$TOTAL_COUNT workflows"

      - name: Commit changes
        if: github.event.inputs.sync_direction == 'pull'
        run: |
          echo "üíæ Committing changes..."
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add workflows/
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            WORKFLOW_NAME="${{ github.event.inputs.workflow_name }}"
            if [ -n "$WORKFLOW_NAME" ]; then
              git commit -m "Sync n8n workflow: $WORKFLOW_NAME"
            else
              git commit -m "Sync all n8n workflows"
            fi
            git push
            echo "‚úÖ Changes committed and pushed"
          fi
