name: N8N Workflow Sync

on:
  workflow_dispatch:
    inputs:
      sync_direction:
        description: 'Sync Direction'
        required: true
        type: choice
        options:
          - push
          - pull
      workflow_name:
        description: 'Workflow Name (leave blank to sync ALL workflows)'
        required: false
        type: string
        default: ''

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Display sync parameters
        run: |
          echo "=== N8N Workflow Sync ==="
          echo "Sync Direction: ${{ inputs.sync_direction }}"
          if [ -z "${{ inputs.workflow_name }}" ]; then
            echo "Workflow Name: ALL WORKFLOWS"
          else
            echo "Workflow Name: ${{ inputs.workflow_name }}"
          fi
          echo "N8N Base URL: ${{ secrets.N8N_BASE_URL }}"
          echo "========================="

      - name: Validate secrets
        env:
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
          N8N_BASE_URL: ${{ secrets.N8N_BASE_URL }}
        run: |
          echo "ğŸ” Validating secrets..."
          
          if [ -z "$N8N_BASE_URL" ]; then
            echo "âŒ ERROR: N8N_BASE_URL secret is not set"
            exit 1
          fi
          
          if [ -z "$N8N_API_KEY" ]; then
            echo "âŒ ERROR: N8N_API_KEY secret is not set"
            exit 1
          fi
          
          # Remove trailing slash from base URL if present
          N8N_BASE_URL="${N8N_BASE_URL%/}"
          echo "N8N_BASE_URL=$N8N_BASE_URL" >> $GITHUB_ENV
          
          echo "âœ… Secrets validated"

      - name: Test n8n API connection
        env:
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          echo "ğŸ”Œ Testing n8n API connection..."
          
          HTTP_STATUS=$(curl -s -o /tmp/api_test.json -w "%{http_code}" \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -H "Accept: application/json" \
            "$N8N_BASE_URL/rest/workflows")
          
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… Successfully connected to n8n API"
            WORKFLOW_COUNT=$(jq '. | length' /tmp/api_test.json 2>/dev/null || echo "0")
            echo "ğŸ“Š Found $WORKFLOW_COUNT workflows in n8n"
          elif [ "$HTTP_STATUS" -eq 401 ]; then
            echo "âŒ ERROR: Authentication failed (401)"
            echo "Please check that N8N_API_KEY is correct"
            exit 1
          elif [ "$HTTP_STATUS" -eq 404 ]; then
            echo "âŒ ERROR: API endpoint not found (404)"
            echo "Please check that N8N_BASE_URL is correct"
            exit 1
          else
            echo "âŒ ERROR: API request failed with status $HTTP_STATUS"
            cat /tmp/api_test.json
            exit 1
          fi

      - name: Create workflows directory
        run: |
          mkdir -p workflows
          echo "ğŸ“ Created/verified workflows directory"

      - name: Pull workflow(s) from N8N
        if: inputs.sync_direction == 'pull'
        env:
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
          WORKFLOW_NAME: ${{ inputs.workflow_name }}
        run: |
          echo "ğŸ“¥ Starting pull operation..."
          
          if [ -z "$WORKFLOW_NAME" ]; then
            echo "ğŸ”„ Pulling ALL workflows from n8n..."
            
            # Get list of all workflows from n8n API
            HTTP_STATUS=$(curl -s -o /tmp/workflows_list.json -w "%{http_code}" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "Accept: application/json" \
              "$N8N_BASE_URL/rest/workflows")
            
            if [ "$HTTP_STATUS" -ne 200 ]; then
              echo "âŒ ERROR: Failed to fetch workflow list (HTTP $HTTP_STATUS)"
              cat /tmp/workflows_list.json
              exit 1
            fi
            
            # Parse workflow IDs and names
            WORKFLOW_COUNT=$(jq '. | length' /tmp/workflows_list.json)
            echo "ğŸ“Š Found $WORKFLOW_COUNT workflows"
            
            if [ "$WORKFLOW_COUNT" -eq 0 ]; then
              echo "âš ï¸  No workflows found in n8n"
              exit 0
            fi
            
            # Process each workflow
            SUCCESS_COUNT=0
            ERROR_COUNT=0
            
            jq -c '.[]' /tmp/workflows_list.json | while read -r workflow_summary; do
              WORKFLOW_ID=$(echo "$workflow_summary" | jq -r '.id')
              WORKFLOW_DISPLAY_NAME=$(echo "$workflow_summary" | jq -r '.name')
              
              echo ""
              echo "  ğŸ“‹ Processing workflow: $WORKFLOW_DISPLAY_NAME (ID: $WORKFLOW_ID)"
              
              # Fetch full workflow data
              HTTP_STATUS=$(curl -s -o "/tmp/workflow_${WORKFLOW_ID}.json" -w "%{http_code}" \
                -H "X-N8N-API-KEY: $N8N_API_KEY" \
                -H "Accept: application/json" \
                "$N8N_BASE_URL/rest/workflows/$WORKFLOW_ID")
              
              if [ "$HTTP_STATUS" -eq 200 ]; then
                # Create safe filename from workflow name (replace spaces and special chars)
                SAFE_NAME=$(echo "$WORKFLOW_DISPLAY_NAME" | tr ' ' '_' | tr -cd '[:alnum:]_-')
                FILENAME="workflows/${SAFE_NAME}_${WORKFLOW_ID}.json"
                
                # Save workflow to file with proper formatting
                jq '.' "/tmp/workflow_${WORKFLOW_ID}.json" > "$FILENAME"
                
                echo "  âœ… Saved: $FILENAME"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                echo "  âŒ Failed to fetch workflow (HTTP $HTTP_STATUS)"
                ERROR_COUNT=$((ERROR_COUNT + 1))
              fi
            done
            
            # Wait for background processes
            wait
            
            echo ""
            echo "ğŸ“Š Pull Summary:"
            echo "  âœ… Successful: $SUCCESS_COUNT"
            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "  âŒ Failed: $ERROR_COUNT"
            fi
            
          else
            echo "ğŸ”„ Pulling specific workflow '$WORKFLOW_NAME'..."
            
            # First, get the list of all workflows to find the ID
            HTTP_STATUS=$(curl -s -o /tmp/workflows_list.json -w "%{http_code}" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "Accept: application/json" \
              "$N8N_BASE_URL/rest/workflows")
            
            if [ "$HTTP_STATUS" -ne 200 ]; then
              echo "âŒ ERROR: Failed to fetch workflow list (HTTP $HTTP_STATUS)"
              exit 1
            fi
            
            # Find workflow by name (case-insensitive search)
            WORKFLOW_ID=$(jq -r --arg name "$WORKFLOW_NAME" \
              '.[] | select(.name | ascii_downcase == ($name | ascii_downcase)) | .id' \
              /tmp/workflows_list.json | head -1)
            
            if [ -z "$WORKFLOW_ID" ] || [ "$WORKFLOW_ID" = "null" ]; then
              echo "âŒ ERROR: Workflow '$WORKFLOW_NAME' not found in n8n"
              echo ""
              echo "Available workflows:"
              jq -r '.[].name' /tmp/workflows_list.json | sed 's/^/  - /'
              exit 1
            fi
            
            echo "âœ“ Found workflow ID: $WORKFLOW_ID"
            
            # Fetch full workflow data
            HTTP_STATUS=$(curl -s -o /tmp/workflow_single.json -w "%{http_code}" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "Accept: application/json" \
              "$N8N_BASE_URL/rest/workflows/$WORKFLOW_ID")
            
            if [ "$HTTP_STATUS" -eq 200 ]; then
              # Create safe filename
              SAFE_NAME=$(echo "$WORKFLOW_NAME" | tr ' ' '_' | tr -cd '[:alnum:]_-')
              FILENAME="workflows/${SAFE_NAME}_${WORKFLOW_ID}.json"
              
              # Save workflow to file with proper formatting
              jq '.' /tmp/workflow_single.json > "$FILENAME"
              
              echo "âœ… Successfully pulled workflow to: $FILENAME"
            else
              echo "âŒ ERROR: Failed to fetch workflow (HTTP $HTTP_STATUS)"
              cat /tmp/workflow_single.json
              exit 1
            fi
          fi

      - name: Push workflow(s) to N8N
        if: inputs.sync_direction == 'push'
        env:
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
          WORKFLOW_NAME: ${{ inputs.workflow_name }}
        run: |
          echo "ğŸ“¤ Starting push operation..."
          
          if [ -z "$WORKFLOW_NAME" ]; then
            echo "ğŸ”„ Pushing ALL workflows to n8n..."
            
            WORKFLOW_COUNT=0
            SUCCESS_COUNT=0
            ERROR_COUNT=0
            
            for workflow_file in workflows/*.json; do
              if [ -f "$workflow_file" ]; then
                workflow_basename=$(basename "$workflow_file" .json)
                echo ""
                echo "  ğŸ“‹ Processing: $workflow_basename"
                
                # Extract workflow ID from filename (format: name_ID.json)
                WORKFLOW_ID=$(echo "$workflow_basename" | grep -oE '[0-9]+$')
                
                if [ -z "$WORKFLOW_ID" ]; then
                  echo "  âš ï¸  Warning: Could not extract workflow ID from filename, skipping"
                  continue
                fi
                
                # Check if workflow exists in n8n
                HTTP_STATUS=$(curl -s -o /tmp/check_response.json -w "%{http_code}" \
                  -H "X-N8N-API-KEY: $N8N_API_KEY" \
                  -H "Accept: application/json" \
                  "$N8N_BASE_URL/rest/workflows/$WORKFLOW_ID")
                
                if [ "$HTTP_STATUS" -eq 200 ]; then
                  # Workflow exists, update it
                  HTTP_STATUS=$(curl -s -o /tmp/push_response.json -w "%{http_code}" \
                    -X PUT \
                    -H "X-N8N-API-KEY: $N8N_API_KEY" \
                    -H "Content-Type: application/json" \
                    -d @"$workflow_file" \
                    "$N8N_BASE_URL/rest/workflows/$WORKFLOW_ID")
                  
                  if [ "$HTTP_STATUS" -eq 200 ]; then
                    echo "  âœ… Updated: $workflow_basename"
                    SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                  else
                    echo "  âŒ Failed to update (HTTP $HTTP_STATUS)"
                    cat /tmp/push_response.json
                    ERROR_COUNT=$((ERROR_COUNT + 1))
                  fi
                else
                  # Workflow doesn't exist, create it
                  HTTP_STATUS=$(curl -s -o /tmp/push_response.json -w "%{http_code}" \
                    -X POST \
                    -H "X-N8N-API-KEY: $N8N_API_KEY" \
                    -H "Content-Type: application/json" \
                    -d @"$workflow_file" \
                    "$N8N_BASE_URL/rest/workflows")
                  
                  if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 201 ]; then
                    echo "  âœ… Created: $workflow_basename"
                    SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                  else
                    echo "  âŒ Failed to create (HTTP $HTTP_STATUS)"
                    cat /tmp/push_response.json
                    ERROR_COUNT=$((ERROR_COUNT + 1))
                  fi
                fi
                
                WORKFLOW_COUNT=$((WORKFLOW_COUNT + 1))
              fi
            done
            
            echo ""
            echo "ğŸ“Š Push Summary:"
            echo "  ğŸ“ Total processed: $WORKFLOW_COUNT"
            echo "  âœ… Successful: $SUCCESS_COUNT"
            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "  âŒ Failed: $ERROR_COUNT"
              exit 1
            fi
            
          else
            echo "ğŸ”„ Pushing specific workflow '$WORKFLOW_NAME' to n8n..."
            
            # Find the workflow file
            WORKFLOW_FILE=$(find workflows -name "*${WORKFLOW_NAME}*.json" | head -1)
            
            if [ -z "$WORKFLOW_FILE" ]; then
              echo "âŒ ERROR: Workflow file matching '$WORKFLOW_NAME' not found in workflows/"
              echo ""
              echo "Available workflow files:"
              ls -1 workflows/*.json 2>/dev/null | sed 's/^/  - /' || echo "  (none)"
              exit 1
            fi
            
            echo "âœ“ Found file: $WORKFLOW_FILE"
            
            # Extract workflow ID from filename
            workflow_basename=$(basename "$WORKFLOW_FILE" .json)
            WORKFLOW_ID=$(echo "$workflow_basename" | grep -oE '[0-9]+$')
            
            if [ -z "$WORKFLOW_ID" ]; then
              echo "âŒ ERROR: Could not extract workflow ID from filename"
              exit 1
            fi
            
            # Check if workflow exists
            HTTP_STATUS=$(curl -s -o /tmp/check_response.json -w "%{http_code}" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "Accept: application/json" \
              "$N8N_BASE_URL/rest/workflows/$WORKFLOW_ID")
            
            if [ "$HTTP_STATUS" -eq 200 ]; then
              # Update existing workflow
              HTTP_STATUS=$(curl -s -o /tmp/push_response.json -w "%{http_code}" \
                -X PUT \
                -H "X-N8N-API-KEY: $N8N_API_KEY" \
                -H "Content-Type: application/json" \
                -d @"$WORKFLOW_FILE" \
                "$N8N_BASE_URL/rest/workflows/$WORKFLOW_ID")
              
              if [ "$HTTP_STATUS" -eq 200 ]; then
                echo "âœ… Successfully updated workflow in n8n"
              else
                echo "âŒ ERROR: Failed to update workflow (HTTP $HTTP_STATUS)"
                cat /tmp/push_response.json
                exit 1
              fi
            else
              # Create new workflow
              HTTP_STATUS=$(curl -s -o /tmp/push_response.json -w "%{http_code}" \
                -X POST \
                -H "X-N8N-API-KEY: $N8N_API_KEY" \
                -H "Content-Type: application/json" \
                -d @"$WORKFLOW_FILE" \
                "$N8N_BASE_URL/rest/workflows")
              
              if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 201 ]; then
                echo "âœ… Successfully created workflow in n8n"
              else
                echo "âŒ ERROR: Failed to create workflow (HTTP $HTTP_STATUS)"
                cat /tmp/push_response.json
                exit 1
              fi
            fi
          fi

      - name: Detect and display changes
        if: inputs.sync_direction == 'pull'
        run: |
          echo ""
          echo "ğŸ” Analyzing changes..."
          echo "========================"
          
          # Check for changes
          git add workflows/
          
          if git diff --cached --quiet; then
            echo "ğŸ“‹ No changes detected - all workflows are up to date"
            echo "NO_CHANGES=true" >> $GITHUB_ENV
          else
            echo "ğŸ“Š Changes detected in workflows:"
            echo ""
            
            # Show file-level changes
            echo "ğŸ“ Files changed:"
            git diff --cached --name-status | while read status file; do
              case "$status" in
                A) echo "  âœ¨ Added: $file" ;;
                M) echo "  ğŸ“ Modified: $file" ;;
                D) echo "  âŒ Deleted: $file" ;;
                *) echo "  ğŸ“„ $status: $file" ;;
              esac
            done
            
            echo ""
            echo "ğŸ“ˆ Detailed changes:"
            git diff --cached --stat
            
            echo "NO_CHANGES=false" >> $GITHUB_ENV
          fi

      - name: Commit and push changes
        if: inputs.sync_direction == 'pull' && env.NO_CHANGES != 'true'
        run: |
          echo ""
          echo "ğŸ’¾ Committing changes..."
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [ -z "${{ inputs.workflow_name }}" ]; then
            git commit -m "sync: Update all n8n workflows from n8n instance"
          else
            git commit -m "sync: Update n8n workflow '${{ inputs.workflow_name }}' from n8n instance"
          fi
          
          git push
          echo "âœ… Changes committed and pushed to repository"

      - name: Sync summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   Sync Complete Summary    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Direction: ${{ inputs.sync_direction }}"
          if [ -z "${{ inputs.workflow_name }}" ]; then
            echo "Workflows: ALL"
          else
            echo "Workflow:  ${{ inputs.workflow_name }}"
          fi
          echo "Status:    âœ… Success"
          
          if [ "${{ inputs.sync_direction }}" == "pull" ]; then
            if [ "$NO_CHANGES" == "true" ]; then
              echo "Changes:   ğŸ“‹ No updates needed"
            else
              echo "Changes:   ğŸ“Š Repository updated"
            fi
          fi
          echo ""
