{
  "name": "Enhanced Owntracks Location Tracker",
  "description": "Advanced Owntracks workflow with distance filtering, rate limiting, and multi-type support",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "owntracks",
        "options": {
          "rawBody": false
        }
      },
      "id": "webhook-owntracks",
      "name": "Webhook - Owntracks",
      "type": "n8n-nodes-base.webhook",
      "position": [256, 304]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Simple and Reliable Owntracks Location Filter\n// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\ntry {\n  // Get the input data\n  const item = $input.item.json;\n  \n  console.log('ğŸ“ Received data:', JSON.stringify(item, null, 2));\n  \n  // Extract location data from Owntracks format\n  const lat = item.lat;\n  const lon = item.lon;\n  const acc = item.acc;  // accuracy\n  const tst = item.tst;  // timestamp\n  const batt = item.batt;  // battery\n  const alt = item.alt;  // altitude\n  const vel = item.vel;  // velocity\n  const tid = item.tid;  // tracker ID\n  const trigger = item.t;  // trigger type\n  const messageType = item._type || 'location';\n  \n  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n  // VALIDATION - Check for required fields only\n  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n  \n  // Check if lat and lon exist (using !== undefined to allow 0 values)\n  if (lat === undefined || lat === null) {\n    console.log('âŒ Missing latitude');\n    return {\n      json: {\n        skip: true,\n        reason: ['Missing latitude'],\n        received_data: item\n      }\n    };\n  }\n  \n  if (lon === undefined || lon === null) {\n    console.log('âŒ Missing longitude');\n    return {\n      json: {\n        skip: true,\n        reason: ['Missing longitude'],\n        received_data: item\n      }\n    };\n  }\n  \n  // Basic range validation\n  if (lat < -90 || lat > 90) {\n    console.log(`âŒ Invalid latitude: ${lat}`);\n    return {\n      json: {\n        skip: true,\n        reason: [`Invalid latitude: ${lat} (must be between -90 and 90)`],\n        received_data: item\n      }\n    };\n  }\n  \n  if (lon < -180 || lon > 180) {\n    console.log(`âŒ Invalid longitude: ${lon}`);\n    return {\n      json: {\n        skip: true,\n        reason: [`Invalid longitude: ${lon} (must be between -180 and 180)`],\n        received_data: item\n      }\n    };\n  }\n  \n  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n  // VALIDATION PASSED - Build output payload\n  // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n  \n  console.log('âœ… Valid location data received');\n  console.log(`   Lat: ${lat}, Lon: ${lon}, Accuracy: ${acc}m`);\n  \n  // Create timestamp in ISO format\n  const timestamp = tst ? new Date(tst * 1000).toISOString() : new Date().toISOString();\n  \n  // Build the payload for Poke\n  const pokePayload = {\n    type: 'location_update',\n    source: 'owntracks',\n    timestamp: timestamp,\n    location: {\n      latitude: lat,\n      longitude: lon,\n      accuracy: acc || null,\n      altitude: alt || null,\n      velocity: vel || null\n    },\n    device: {\n      tracker_id: tid || null,\n      battery: batt || null,\n      trigger: trigger || null\n    },\n    metadata: {\n      message_type: messageType,\n      raw_timestamp: tst,\n      processed_at: new Date().toISOString()\n    }\n  };\n  \n  console.log('ğŸ“¤ Payload ready for Poke:', JSON.stringify(pokePayload, null, 2));\n  \n  // Return the data - this will pass to the next node\n  return {\n    json: {\n      skip: false,\n      poke_payload: pokePayload,\n      original_data: item\n    }\n  };\n  \n} catch (error) {\n  // Handle any unexpected errors\n  console.error('âŒ ERROR in filter node:', error.message);\n  console.error('Stack:', error.stack);\n  \n  return {\n    json: {\n      skip: true,\n      reason: ['Error processing data: ' + error.message],\n      error: error.message,\n      received_data: $input.item.json\n    }\n  };\n}"
      },
      "id": "enhanced-filter",
      "name": "Filter Location Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [464, 304]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.skip }}",
              "value2": false
            }
          ]
        }
      },
      "id": "check-skip",
      "name": "Should Send?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [656, 304]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://poke.com/api/v1/inbound-sms/webhook",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $json.poke_payload }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          },
          "timeout": 10000,
          "retry": {
            "enabled": true,
            "maxAttempts": 3,
            "waitBetween": 1000
          }
        }
      },
      "id": "send-to-poke",
      "name": "Send to Poke",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [864, 208]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const item = $input.item.json;\nconst response = item.body || item;\n\nconsole.log('âœ… Successfully sent to Poke');\nconsole.log('Response:', JSON.stringify(response, null, 2));\n\nreturn {\n  json: {\n    success: true,\n    status: item.statusCode || 200,\n    message: 'Update sent to Poke',\n    timestamp: new Date().toISOString(),\n    stats: response.workflow_stats || null\n  }\n};"
      },
      "id": "log-success",
      "name": "Log Success",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1056, 208]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const item = $input.item.json;\n\nconsole.log('â­ï¸ Update skipped');\nconsole.log('Reason:', item.reason || 'No reason provided');\nconsole.log('Received data:', JSON.stringify(item.received_data || item.original_data, null, 2));\n\nreturn {\n  json: {\n    skipped: true,\n    reason: item.reason,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "log-skipped",
      "name": "Log Skipped",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [864, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const error = $input.item.json;\n\nconsole.error('âŒ Error processing update');\nconsole.error('Error:', JSON.stringify(error, null, 2));\n\n// Extract meaningful error information\nconst errorMessage = error.message || \n  error.error?.message ||\n  (error.cause && JSON.stringify(error.cause)) ||\n  'Unknown error';\n\nreturn {\n  json: {\n    error: true,\n    message: errorMessage,\n    details: error,\n    timestamp: new Date().toISOString(),\n    // Add context for debugging\n    context: {\n      statusCode: error.statusCode,\n      url: error.config?.url,\n      method: error.config?.method\n    }\n  }\n};"
      },
      "id": "handle-error",
      "name": "Handle Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1056, 304]
    }
  ],
  "connections": {
    "Webhook - Owntracks": {
      "main": [
        [
          {
            "node": "Filter Location Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Location Data": {
      "main": [
        [
          {
            "node": "Should Send?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Send?": {
      "main": [
        [
          {
            "node": "Send to Poke",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Skipped",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send to Poke": {
      "main": [
        [
          {
            "node": "Log Success",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Handle Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {}
}